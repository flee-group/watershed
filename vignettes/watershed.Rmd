---
title: "watershed"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{watershed}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(watershed)
```


## 0. Preparing the installation

Be sure you have followed the installation guide and have a working installation of `watershed`, `rgrass7`, and Grass GIS 7.4 or 7.6 (other version may work, but are untested).

## 0.5. Preparing the DEM

Many workflows advise either using a "burned-in" DEM or a "filled" DEM to avoid topological problems. The tools used by `watershed` should in theory not require either of those steps, so in general it is recommended you skip this step unless you encounter problems later on. Burning in a DEM is not yet supported, so if this step is required it is best to use another tool and then bring the already burned DEM into R. Filling the DEM is supported however; see `?fill_dem`. 

## 1. Delineating the stream

The pared-down workflow offered by `watershed` provides a relatively quick way to go from a dem to a stream map. We will make a first-draft map using the `ybbs_dem` dataset provided by this package, for the Ybbs river in Austria. The DEM is a `raster`, so we load this package as well.

```{r dem}
library(raster)
data(ybbs_dem)
plot(ybbs_dem, col=terrain.colors(20), axes = FALSE)
```

The `delineate()` function is the main workhorse here. The resulting raster stack contains 3 layers: `accum` is the flow accumulation, `drainage` is the drainage direction, and `stream` is the stream map.

```{r delineate, cache = TRUE}
ybbs = delineate(ybbs_dem)
plot(ybbs_dem, col=terrain.colors(20), axes = FALSE)
plot(ybbs$stream, col='blue', add = TRUE, legend = FALSE)
```

The defaults produce pretty good results in this case. Perhaps we know from on-the-ground work, or aerial photo inspection, that there are more streams that what is produced here. We can improve this with the `threshold` parameter, which sets the default minimum basin size. This defaults to 1e5 m^2, or 0.1 km^2. Here we reduce it by half; note that this gives us a warning about possible long computation times; it's not such a problem here, because the Ybbs is a relatively small area, but with large DEMs this can make the computation very slow.

```{r delineate2, cache = TRUE}
ybbs = delineate(ybbs_dem, threshold = 0.5e5)
plot(ybbs_dem, col=terrain.colors(20), axes = FALSE)
plot(ybbs$stream, col='blue', add = TRUE, legend = FALSE)
```

Too many! We try again with a higher threshold.

```{r delineate3, cache = TRUE}
ybbs = delineate(ybbs_dem, threshold = 0.95e5)
plot(ybbs_dem, col=terrain.colors(20), axes = FALSE)
plot(ybbs$stream, col='blue', add = TRUE, legend = FALSE)
```


## 2. Selecting a single basin

We would like to restrict our stream map to a single catchment. `delineate` offers this option; here we set `outlet = NA`, which will use the largest stream as the outlet for the desired basin. Alternatively, we could zoom in on the layer and choose the x-y coordinates of the outlet we wanted to use, and provide these as a vector in outlet.

```{r delineate3, cache = TRUE}
ybbs = delineate(ybbs_dem, threshold = 0.95e5, outlet = c(4704445, 2847440))
plot(ybbs_dem, col=terrain.colors(20), axes = FALSE)
plot(ybbs$catchment, col = "#2277FF66", add = TRUE, legend = FALSE)
plot(ybbs$stream, col='blue', add = TRUE, legend = FALSE)
```